jQuery(document).ready((()=>{new BulkImportHandler}));class BulkImportHandler{constructor(){this.messageQueue=[],this.isDisplaying=!1,this.postType="movie",this.importType="tmdb",this.skipExisting="true",this.tmdbIdFinal={},this.errorWrapper=jQuery(".bulk-import-errors-wrapper"),this.errorIds=[],this.isPaused=!1,this.isCanceled=!1,this.initEventListeners()}initEventListeners(){jQuery(".tab-selector.fp-import-type .tab-button").on("click",(e=>{this.handleFPImportTypeChange(e)})),jQuery(".tab-selector.import-type .tab-button").on("click",(e=>{this.handleImportTypeChange(e)})),jQuery(".tab-selector.post-type .tab-button").on("click",(e=>{this.handlePostTypeChange(e)})),jQuery(".tab-selector.skip-existing .tab-button").on("click",(e=>{this.handleSkipExistingChange(e)})),jQuery(".fp-bulk-submit_btn").on("click",(e=>{this.handleBulkSubmitClick()})),jQuery(".fp-processing-progress-pause").on("click",(e=>{this.pauseHandler()})),jQuery(".fp-processing-progress-cancel").on("click",(e=>{this.cancelHandler()}))}showError(message){this.messageQueue.push(message),this.displayNextError()}displayNextError(){if(!this.isDisplaying&&this.messageQueue.length>0){this.isDisplaying=!0;var message=this.messageQueue.shift(),$errorWrapper=jQuery(".bulk-import-errors-wrapper");$errorWrapper.find(".bulk-import-error").text(message),$errorWrapper.css({display:"flex",opacity:0}).animate({opacity:1},1e3),setTimeout((()=>{$errorWrapper.animate({opacity:0},1e3,(()=>{$errorWrapper.css("display","none"),this.isDisplaying=!1,this.displayNextError()}))}),3e3)}}sanitize_tmdb_ids(tmdb_ids){let tmdb_ids_arr=tmdb_ids.split(/[\n,]/).map((function(id){return id.trim()})).filter((function(id){return""!==id&&!isNaN(id)}));return tmdb_ids_arr=[...new Set(tmdb_ids_arr)],tmdb_ids_arr}checkTMDB_ID(tmdb_ids){return this.postType="tv"===this.postType?"series":"movie",new Promise(((resolve,reject)=>{jQuery.ajax({url:fp_bi_data.ajax_url,type:"POST",data:{action:"check_tmdb_id_exists",tmdb_ids:JSON.stringify(tmdb_ids),mtg_post_type:this.postType,nonce:fp_bi_data.nonce},success:response=>{if(response.success&&response.data.existence_map){var data=response.data.existence_map;resolve(data)}else reject("No data received or error in response")},error:function(jqXHR,textStatus,errorThrown){try{const responseJSON=JSON.parse(jqXHR.responseText);reject(responseJSON.data.message)}catch(error){reject("Error validating postData.")}reject("Error: "+textStatus)}})}))}pauseHandler(){this.isPaused=!this.isPaused,document.getElementById("fp-processing-progress-pause").innerText=this.isPaused?"Resume":"Pause"}cancelHandler(){this.isCanceled=!0,document.getElementById("fp-processing-progress-cancel").innerText="Canceled"}handleFPImportTypeChange(e){const $target=jQuery(e.currentTarget);$target.siblings().removeClass("active"),$target.addClass("active"),"all"===$target.val()?jQuery(".fp-auto-option-recent").hide():"recent"===$target.val()&&jQuery(".fp-auto-option-recent").css("display","grid")}handleImportTypeChange(e){const $target=jQuery(e.currentTarget);$target.siblings().removeClass("active"),$target.addClass("active"),"tmdb"===$target.val()?(jQuery(".tmdb-id-input-box").css("display","grid"),jQuery(".fp-auto-option").hide()):"fp"===$target.val()&&(jQuery(".tmdb-id-input-box").hide(),jQuery(".fp-auto-option").css("display","grid")),this.importType=$target.val()}handlePostTypeChange(e){const $target=jQuery(e.currentTarget);$target.siblings().removeClass("active"),$target.addClass("active"),this.postType=$target.val()}handleSkipExistingChange(e){const $target=jQuery(e.currentTarget);$target.siblings().removeClass("active"),$target.addClass("active"),this.skipExisting=$target.val(),"false"===this.skipExisting?(jQuery(".skip-existing-false").show(),jQuery(".skip-existing-true").hide()):(jQuery(".skip-existing-false").hide(),jQuery(".skip-existing-true").show())}handleBulkSubmitClick(){if(this.importType=jQuery(".tab-selector.import-type .tab-button.active").val(),this.postType=jQuery(".tab-selector.post-type .tab-button.active").val(),this.skipExisting=jQuery(".tab-selector.skip-existing .tab-button.active").val(),"tmdb"===this.importType){let tmdbIds=jQuery(".tmdb-ids-textarea").val();if(this.tmdbIds=this.sanitize_tmdb_ids(tmdbIds),""===tmdbIds||0===this.tmdbIds.length)return this.showError("Please enter valid TMDB IDs to import."),void jQuery(".tmdb-ids-textarea").css("border","1px solid red");this.checkTMDB_ID(this.tmdbIds).then((data=>{this.tmdbIdFinal=data,this.postHandler()})).catch((error=>{this.showError(error)}))}else if("fp"===this.importType){const fp_import_type=jQuery(".tab-selector.fp-import-type .tab-button.active").val();if("all"===fp_import_type)jQuery(".fp-bulk-submit_btn").hide(),jQuery(".fp-bulk-single-submit .loader-area").css("display","flex"),this.getFPiDs().then((data=>{this.checkTMDB_ID(data).then((data=>{this.tmdbIdFinal=data,this.postHandler()})).catch((error=>{this.showError(error),jQuery(".fp-bulk-single-submit .loader-area").hide(),jQuery(".fp-bulk-submit_btn").show()}))})).catch((error=>{this.showError(error),jQuery(".fp-bulk-single-submit .loader-area").hide(),jQuery(".fp-bulk-submit_btn").show()}));else if("recent"===fp_import_type){let post_number=jQuery(".fp-bulk-add-wrapper #recent-numbers").val();if(post_number=parseInt(post_number),""===post_number||isNaN(post_number)||post_number<=0||post_number>500)return void this.showError("Please enter a valid number of posts to import. [0-500]");jQuery(".fp-bulk-submit_btn").hide(),jQuery(".fp-bulk-single-submit .loader-area").css("display","flex"),this.getFPRecentIDs(post_number).then((data=>{this.checkTMDB_ID(data).then((data=>{this.tmdbIdFinal=data,this.postHandler()})).catch((error=>{this.showError(error),jQuery(".fp-bulk-single-submit .loader-area").hide(),jQuery(".fp-bulk-submit_btn").show()}))})).catch((error=>{this.showError(error),jQuery(".fp-bulk-single-submit .loader-area").hide(),jQuery(".fp-bulk-submit_btn").show()}))}}}promiseQueue(promises,maxConcurrent){let index=0,results=[],activePromises=0;return new Promise(((resolve,reject)=>{const next=()=>{if(this.isCanceled)reject("Process canceled");else if(index!==promises.length||0!==activePromises)for(;activePromises<maxConcurrent&&index<promises.length;){if(this.isPaused)return void setTimeout(next,100);activePromises++,promises[index]().then((result=>{results.push(result),activePromises--,next()})).catch((error=>{results.push(Promise.reject(error)),activePromises--,next()})),index++}else resolve(results)};next()}))}postHandler(){const f_tmdb=this.tmdbIdFinal,total=Object.keys(this.tmdbIdFinal).length,post_type="movie"===this.postType?"movie":"tv";let current=0;this.boundOptimizationHandler=this.enable_optimizations.bind(this),this.updateView(0);const createOrUpdatePromises=Object.keys(this.tmdbIdFinal).map((id=>()=>new Promise(((resolve,reject)=>{if(jQuery(".fp-progress-current-tmdb").text(id),f_tmdb[id].exists&&"true"!==this.skipExisting){const post_id=f_tmdb[id].post_id;if(post_id)return this.updateHandler(post_id,id,post_type).then((()=>{current++,this.updateProgress(total,current),resolve()})).catch((error=>{"function"==typeof fpLog&&fpLog("JS","M : Error in update-post click event."),this.errorIds.push(id),current++,this.updateProgress(total,current),reject(error)}));current++,this.updateProgress(total,current),resolve()}else{if(!f_tmdb[id].exists)return this.createHandler(id).then((()=>{current++,this.updateProgress(total,current),resolve()})).catch((error=>{this.errorIds.push(id),current++,this.updateProgress(total,current),reject(error)}));current++,this.updateProgress(total,current),resolve()}})))).filter((fn=>"function"==typeof fn));this.disable_optimizations().then((()=>(window.addEventListener("beforeunload",this.boundOptimizationHandler),this.promiseQueue(createOrUpdatePromises,2)))).then((()=>{this.enable_optimizations()})).then((()=>{window.removeEventListener("beforeunload",this.boundOptimizationHandler),jQuery(".bulk-actions-buttons").hide(),jQuery(".fp-processing-progress-status").text("âœ… All Process Completed."),jQuery(".fp-processing-complete").css("display","flex"),jQuery(".fp-processing-failed-count").text(this.errorIds.length),!this.errorIds.length>0&&jQuery(".fp-processing-failed-ids").hide(),jQuery(".fp-processing-failed-tmdb-ids").text(this.errorIds.join(", "))})).catch((error=>{"function"==typeof fpLog&&fpLog("JS","M : Error in postHandler."),console.error("Error during post handling:",error),this.showError(error),this.enable_optimizations().finally((()=>{window.removeEventListener("beforeunload",this.boundOptimizationHandler)}))}))}disable_optimizations(){return new Promise(((resolve,reject)=>{jQuery.ajax({url:fp_bi_data.ajax_url,type:"POST",data:{action:"fp_disableOptimizations",nonce:fp_bi_data.disable_opt_nonce},success:response=>{resolve()},error:error=>{"function"==typeof fpLog&&fpLog("JS","Error in disable_optimizations."),reject(error)}})}))}enable_optimizations(){return new Promise(((resolve,reject)=>{jQuery.ajax({url:fp_bi_data.ajax_url,type:"POST",data:{action:"fp_enableOptimizations",nonce:fp_bi_data.enable_opt_nonce},success:response=>{resolve()},error:error=>{"function"==typeof fpLog&&fpLog("JS","Error in enable_optimizations."),reject(error)}})}))}createHandler(id){const tmdbData={p_type:"movie"===this.postType?"movie":"tv",tmdb_id:id};return new Promise(((resolve,reject)=>{jQuery.ajax({url:fp_bi_data.ajax_url,type:"POST",data:{action:"create_movie_post",nonce:fp_bi_data.nonce,tmdbData:tmdbData},success:response=>{response.success?resolve():(this.showError(response.data.message),reject())},error:error=>{"function"==typeof fpLog&&fpLog("JS","Error in createHandler."),reject()}})}))}updateHandler(post_id,tmdb_id,post_type){const postData={post_id:post_id,post_type:post_type,tmdb_id:tmdb_id};return new Promise(((resolve,reject)=>{jQuery.ajax({url:fp_bi_data.ajax_url,type:"POST",data:{action:"update_movie_post",nonce:fp_bi_data.update_post_nonce,fp_postData:postData},success:response=>{response.success?resolve():(this.showError(response.data.message),reject())},error:error=>{"function"==typeof fpLog&&fpLog("JS","Error in updateHandler."),reject()}})}))}updateProgress(total,current){var progress=Math.round(current/total*100);jQuery(".fp-processing-progress-bar").css("width",progress+"%"),jQuery(".fp-processing-progress-bar-text").text(progress+"%")}updateView(type){0===type?(jQuery(".mtg_bulk_import_wrapper").hide(),jQuery(".fp-processing-wrapper").show()):(jQuery(".mtg_bulk_import_wrapper").show(),jQuery(".fp-processing-wrapper").hide())}getFPiDs(paged=1,tmdb_ids=[]){return new Promise(((resolve,reject)=>{jQuery.ajax({url:fp_bi_data.ajax_url,type:"POST",data:{action:"fp_getAllIDs",nonce:fp_bi_data.fp_get_all_ids_nonce,post_type:this.postType,paged:paged},success:response=>{response.success&&response.data.tmdb_ids?(tmdb_ids=tmdb_ids.concat(response.data.tmdb_ids),paged<response.data.total_pages?this.getFPiDs(paged+1,tmdb_ids).then(resolve).catch(reject):resolve(tmdb_ids)):reject("No data received or error in response")},error:function(jqXHR,textStatus,errorThrown){try{const responseJSON=JSON.parse(jqXHR.responseText);reject(responseJSON.data.message)}catch(error){reject("Error validating postData.")}reject("Error: "+textStatus)}})}))}getFPRecentIDs(post_number){return new Promise(((resolve,reject)=>{jQuery.ajax({url:fp_bi_data.ajax_url,type:"POST",data:{action:"fp_getRecentIDs",nonce:fp_bi_data.fp_get_all_ids_nonce,post_type:this.postType,number:post_number},success:response=>{response.success&&response.data.tmdb_ids?resolve(response.data.tmdb_ids):reject("No data received or error in response")},error:function(jqXHR,textStatus,errorThrown){try{const responseJSON=JSON.parse(jqXHR.responseText);reject(responseJSON.data.message)}catch(error){reject("Error validating postData.")}reject("Error: "+textStatus)}})}))}}