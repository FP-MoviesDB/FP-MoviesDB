class PostGenerator{constructor(){if(document.getElementById("wpcontent").style.paddingLeft="0px",this.previousQuery="",this.currentTab=localStorage.getItem("mtg_tab")||"movie",this.currentTabSource=localStorage.getItem("mtg_source")||"tmdb",this.searchQuery="",this.search_type="trending",this.edit_post_link="",this.search_btn=document.getElementById("search_movie_btn"),this.search_input=document.querySelector(".search_input_field"),this.currentTab_btn=document.getElementById(this.currentTab),this.currentTabSource_btn=document.getElementById(this.currentTabSource),this.pluginUrl=movieTvVars.plugin_url,this.TMDB_KEY=movieTvVars.apiKeys.mtg_tmdb_api_key,this.FP_KEY=movieTvVars.apiKeys.mtg_fp_api_key,null!==this.search_btn&&null!==this.search_input){if(!this.TMDB_KEY||!this.FP_KEY)return this.manageSearchFields(this.search_btn,!0),this.add_search_report("INIT","Please set the TMDB and FP APIKeys in the plugin settings.","darkred"),errorText.textContent="Please set the TMDB and FP APIKeys in the plugin settings.",errorText.style.color="darkred",void(errorText.style.textAlign="center");this.add_search_report("INIT","Movie TV Generator Initialized.","gray"),this.initButtons("tab-button",this.currentTab),this.initButtons("source-button",this.currentTabSource),this.loadTrendingContent()}else"function"==typeof fpLog&&fpLog("JS","Search button or input field not found.")}initButtons(e,t){const s=document.getElementsByClassName(e);for(let e=0;e<s.length;e++)s[e].classList.toggle("active",s[e].id===t)}selectTab(e,t){this.updateActiveButton("tab-button",t),this.currentTab=t,localStorage.setItem("mtg_tab",this.currentTab),this.cleanUpResults(),this.loadTrendingContent()}selectSource(e,t){this.updateActiveButton("source-button",t),this.currentTabSource=t,localStorage.setItem("mtg_source",this.currentTabSource),this.cleanUpResults(),this.loadTrendingContent()}updateActiveButton(e,t){const s=document.getElementsByClassName(e);for(let e=0;e<s.length;e++)s[e].classList.toggle("active",s[e].id===t)}loadTrendingContent(){this.cleanUpResults();var e="tmdb"===this.currentTabSource?"Trending":"Latest FP";this.add_search_report("DEFAULT",`Loading ${e} -> ${this.currentTab.charAt(0).toUpperCase()+this.currentTab.slice(1)}`,"purple"),document.getElementById("search_loading").style.display="flex",this.manageSearchFields(this.search_btn,!0),this.manageSearchFields(this.currentTab_btn,!0),this.manageSearchFields(this.currentTabSource_btn,!0),this.makeAPIRequest(this.currentTab,"trending","none","1",this.currentTabSource)}add_search_report(e,t,s="black",r=!1,a=!1,n="",i="und",o="und",c="und",l=""){const d=document.getElementById("result-report"),u=document.createElement("div");u.className="result-report-grid",u.style.opacity=0;const h=document.createElement("div");h.className="report_type",h.innerHTML=`<p class="report_type_text">${e}</p>`,h.style.fontWeight="bold",h.style.color=s;const p=document.createElement("div");p.className="report_text",p.innerHTML=r||a?`\n        <p class="report_text_text">\n        ${t} -> \n        <a href="${n}" target="_blank">edit</a>  |  \n        <a href="${l}" target="_blank">view</a>  |  \n        <a href="https://www.themoviedb.org/${c}/${o}" target="_blank">TMDB: ${o}</a>\n        </p>`:`<p class="report_text_text">${t}</p>`,u.appendChild(h),u.appendChild(p),d.appendChild(u),u.offsetWidth,u.style.opacity=1,setTimeout((()=>{u.style.opacity=1,d.scrollTop=d.scrollHeight}),100)}async makeAPIRequest(e,t,s,r=1,a){if(e&&t&&["movie","tv"].includes(e)&&["search","id","trending"].includes(t))if("search"!==t&&"id"!==t||s)try{const n=await this.fetch_tmdb_data(e,t,s,r,a);if(!n)throw this.add_search_report("SEARCH",`${n.message}`,"red"),new Error(n.message);const i=await n;if(!i)throw this.add_search_report("SEARCH",n.message,"red"),new Error(n.message);const o=i.results;if("search"===t&&o&&o.length>0)this.displayResults_keyword(o,i.pages,i.page,i.mtime,i.total);else if("id"===t&&o)this.displayResults_keyword([o],1,1,i.mtime,1);else if("trending"===t&&"tmdb"===a&&o)this.displayResults_keyword(o,1,1,i.mtime,1);else if("trending"===t&&"fp"===a&&o&&o.length<1)this.add_search_report("SEARCH","No Files Found in FilePress.","red"),this.setBackTypeInCaseOfError();else{if(!("trending"===t&&"fp"===a&&o&&o.length>0))throw this.setBackTypeInCaseOfError(),new Error(n.message);this.displayResults_keyword(o,i.pages,i.page,i.mtime,i.total)}}catch(e){this.add_search_report("SEARCH",`${e}`,"red"),this.setBackTypeInCaseOfError()}else"function"==typeof fpLog&&fpLog("JS","Empty query for search or id search type.");else"function"==typeof fpLog&&fpLog("JS","Invalid or incomplete parameters for API request.")}displayResults_keyword(e,t,s,r,a){const n=document.getElementById("results-inner-container");if(!n)return void("function"==typeof fpLog&&fpLog("JS","The container #results-inner-container does not exist."));n.style.display="flex",1===s&&(n.innerHTML="");let i=0;const o=e.map((e=>e.id));this.checkTMDB_ID(o).then((o=>{e.forEach((e=>{const t=o[e.id].exists;let s=o[e.id].post_id;const r=this.createResultCard(e,t,s);n.appendChild(r)})),this.updateLoadMoreButton(s,t),this.setBackTypeInCaseOfError(),i=n.querySelectorAll(".tmdb_card").length,this.display_tmdb_status(a,i,s,r)})).catch((e=>{this.add_search_report("SEARCH",`${e.message}`,"red"),this.setBackTypeInCaseOfError(),"function"==typeof fpLog&&fpLog("JS",e)}))}setBackTypeInCaseOfError(){document.getElementById("search_loading").style.display="none",this.manageSearchFields(this.search_btn),this.manageSearchFields(this.currentTab_btn),this.manageSearchFields(this.currentTabSource_btn)}display_tmdb_status(e,t,s,r){const a=document.getElementById("results-inner-container_status");document.getElementById("results-inner-container_status_text").textContent=`About ${e} results found, loaded ${t} items & current page is ${s}. (${r} seconds)`,a.style.display="block",a.style.paddingLeft="10px"}updateLoadMoreButton(e,t){const s=document.getElementById("load-more"),r=document.getElementById("load-more-button");r&&(s.removeChild(r),document.getElementById("load_more_results_btn_div_container")?.remove());const a=document.createElement("div");a.id="load_more_results_btn_div_container",a.style.cssText="display: none; justify-content: center; align-items: center; height: 100%; max-w";const n=document.createElement("div");if(n.id="load-more-loading",n.style.cssText="position: relative; width: 30px; height: 30px;",n.innerHTML=`<img class="animate-spin" src="${this.pluginUrl}/img/loading.webp" alt="loading" style="width: 100%; height: 100%;">`,a.appendChild(n),e<t){s.style.cssText="display: flex; justify-content: center; align-items: center; flex-direction: column;";const t=document.createElement("button");t.id="load-more-button",t.classList.add("load_more_btn"),t.textContent="Load More",t.onclick=()=>{a.style.display="flex",s.appendChild(a),this.makeAPIRequest(this.currentTab,this.search_type,this.searchQuery,e+1,this.currentTabSource),t.style.display="none"},s.appendChild(t)}}createTickForExisting(){const e=document.createElement("div");return e.className="existing-tmdb-id",e.style.cssText="position: absolute; top: 0; right: 0; z-index: 1; cursor: not-allowed;",e.innerHTML=`<img src="${this.pluginUrl}/img/green-tick.webp" alt="Exists" style="width: 24px; height: 24px;">`,e}createLoadingAnimation(){const e=document.createElement("div");return e.id="add-post-loading",e.style.cssText="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); -webkit-transform: translate(-50%, -50%); -moz-transform: translate(-50%, -50%); -ms-transform: translate(-50%, -50%); -o-transform: translate(-50%, -50%);",e.innerHTML=`<img class="animate-spin" src="${this.pluginUrl}/img/loading.webp" alt="adding-post" style="width: 100%; height: 100%;">`,e}getPosterFullPath(e){let t;return t=e?`https://image.tmdb.org/t/p/w154${e}`:"https://imgshare.xyz/img/4/666a6128c0fff3ca1bfc7715/ImageNotFound.png",t}createValidPostData(e){if(!e)return null;return{p_type:this.currentTab,tmdb_id:e.id}}createResultCard(e,t,s){const r=document.createElement("div");let a=e.release_date??e.first_air_date??"",n=e.title??e.name??"Untitled",i=this.getPosterFullPath(e.poster_path??"");r.classList.add("tmdb_result_item","tmdb_card");const o=document.createElement("div");o.className="search_img_wrapper",o.style.position="relative",o.style.overflow="hidden";const c=document.createElement("img");c.src=i,c.alt=n,c.className="tmdb-poster";const l=document.createElement("div");if(l.className="card-info",l.innerHTML=`\n        <p class='card-p-base card-title'>${n}</p><br />\n        <p class='card-p-base card-year'>${a}</p>\n    `,t){let t=this.createTickForExisting();o.appendChild(t),c.style.opacity=.8,c.style.filter="grayscale(80%)","null"!==s?(c.style.cursor="pointer",c.onclick=()=>{if(confirm("Post already exists. Do you want to ReFetch data again?")){let t={tmdb_id:e.id,post_type:this.currentTab,post_id:s,response_required:!0};this.updatePostFromTMDB_Data(t,o,c)}}):(c.style.cursor="not-allowed",c.onclick=null)}else{c.style.cursor="pointer";let t=this.createValidPostData(e);c.onclick=()=>{this.createPostFromTMDB_Data(t,o,c)}}return o.appendChild(c),r.appendChild(o),r.appendChild(l),r}fetch_tmdb_data(e,t,s,r,a){return new Promise(((n,i)=>{jQuery.ajax({url:movieTvVars.ajax_url,type:"POST",data:{action:"fp_app_search",type:e,s_type:t,query:s,page_number:r,source:a,nonce:movieTvVars.nonce},success:e=>{n(e)},error:function(e,t,s){"function"==typeof fpLog&&fpLog("JS","Request failed [Fetch_TMDB_Data]: "+t+", "+s),i(!1)}})}))}checkTMDB_ID(e){let t="movie"===this.currentTab?"movie":"series";return new Promise(((s,r)=>{jQuery.ajax({url:movieTvVars.ajax_url,type:"POST",data:{action:"check_tmdb_id_exists",tmdb_ids:JSON.stringify(e),mtg_post_type:t,nonce:movieTvVars.nonce},success:e=>{e.success&&e.data.existence_map?s(e.data.existence_map):r("No data received or error in response")},error:function(e,t,s){"function"==typeof fpLog&&fpLog("JS","Request failed [Check_TMDB_Exist_FUNCTION]: "+t+", "+s);try{const t=JSON.parse(e.responseText);r(t.data.message)}catch(e){r("Error validating postData.")}r("Error: "+t)}})}))}checkTMDB_ID_FP(e,t){try{jQuery.ajax({url:movieTvVars.ajax_url,type:"POST",data:{action:"check_if_tmdb_id_exists_fp",tmdb_id:e,type:t,nonce:movieTvVars.nonce},success:e=>e.exists,error:function(e,t,s){return"function"==typeof fpLog&&fpLog("JS","Request failed [Check_TMDB_Exist_FP]: "+t+", "+s),!1}})}catch(e){return"function"==typeof fpLog&&fpLog("JS","Error: "+e),!1}}createPostFromTMDB_Data(e,t,s){let r=this.createLoadingAnimation();const a=this;t.appendChild(r);try{s.style.opacity=.5,s.style.filter="grayscale(100%)",jQuery.ajax({url:movieTvVars.ajax_url,type:"POST",data:{action:"create_movie_post",nonce:movieTvVars.nonce,tmdbData:e},success:e=>{let a=e?.data.post_id??"null",n=e?.data.post_edit_url??"",i=e?.data.tmdb_id??"",o=e?.data.post_type??"",c=e?.data.preview_url??"";this.add_search_report("POST","Post Created","green",!0,!1,n,a,i,o,c),s.style.cursor="not-allowed",s.onclick=null;let l=this.createTickForExisting();return t.removeChild(r),t.appendChild(l),e.data.post_id},error:function(e,n,i){t.removeChild(r),s.style.opacity=1,s.style.filter="none","function"==typeof fpLog&&fpLog("JS","Request failed [Create_Post]: "+n+", "+i);try{var o=JSON.parse(e.responseText);a.add_search_report("POST",`${o.data.message}`,"red")}catch(e){a.add_search_report("POST",`${i}`,"red")}return!1}})}catch(e){return t.removeChild(r),s.style.opacity=1,s.style.filter="none","function"==typeof fpLog&&fpLog("JS","Error: "+e),!1}}updatePostFromTMDB_Data(e,t,s){let r=this.createLoadingAnimation();t.appendChild(r);try{s.style.opacity=.5,s.style.filter="grayscale(100%)",jQuery.ajax({url:movieTvVars.ajax_url,type:"POST",data:{action:"update_movie_post",nonce:movieTvVars.updateNonce,fp_postData:e},success:e=>{if(e.success){let a=e?.data.post_id??"null",n=e?.data.post_edit_url??"",i=e?.data.tmdb_id??"",o=e?.data.post_type??"",c=e?.data.preview_url??"";this.add_search_report("UPDATE","Post Updated","blue",!0,!1,n,a,i,o,c),s.style.cursor="not-allowed",s.onclick=null,t.removeChild(r);let l=this.createTickForExisting();t.appendChild(l)}else t.removeChild(r),s.style.opacity=1,s.style.filter="none",this.add_search_report("UPDATE",`${e.data.message}`,"red")},error:(e,a,n)=>{t.removeChild(r),s.style.opacity=1,s.style.filter="none",this.add_search_report("UPDATE",`Error: ${n}`,"red"),"function"==typeof fpLog&&fpLog("JS","Request failed [Update_Post]: "+a+", "+n)}})}catch(e){t.removeChild(r),s.style.opacity=1,s.style.filter="none","function"==typeof fpLog&&fpLog("JS","Error: "+e),this.add_search_report("UPDATE",`Error: ${e.message}`,"red")}}async searchInitiator(){if(this.searchQuery=document.getElementById("mtg_query").value.trim(),!this.searchQuery)return this.add_search_report("SEARCH","Please enter a search query.","red");this.previousQuery=this.searchQuery,this.cleanUpResults();let e=!isNaN(this.searchQuery)&&!isNaN(parseFloat(this.searchQuery));this.search_type=e?"id":"search",document.getElementById("search_loading").style.display="flex",this.manageSearchFields(this.search_btn,!0),this.add_search_report("SEARCH",`Searching for: ${this.searchQuery}`,"green"),await this.makeAPIRequest(this.currentTab,this.search_type,this.searchQuery)}manageSearchFields(e,t=!1){e.disabled=t,e.style.cursor=e.disabled?"not-allowed":"pointer",this.search_input.style.cursor=e.disabled?"not-allowed":"text",this.search_input.readOnly=e.disabled}cleanUpResults(){document.getElementById("results-inner-container").innerHTML="",document.getElementById("load-more").style.display="none",document.getElementById("results-inner-container_status").style.display="none",this.manageSearchFields(this.search_btn),this.manageSearchFields(this.currentTab_btn),this.manageSearchFields(this.currentTabSource_btn)}}document.addEventListener("DOMContentLoaded",(e=>{const t=new PostGenerator;window.postGen=t,document.querySelector(".tab-selector").addEventListener("click",(e=>{e.target.classList.contains("tab-button")&&t.selectTab(e,e.target.id)})),document.querySelector(".source-selector").addEventListener("click",(e=>{e.target.classList.contains("source-button")&&t.selectSource(e,e.target.id)}))}));