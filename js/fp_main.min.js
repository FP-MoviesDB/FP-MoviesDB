class PostGenerator{constructor(){if(document.getElementById("wpcontent").style.paddingLeft="0px",this.previousQuery="",this.currentTab=localStorage.getItem("mtg_tab")||"movie",this.currentTabSource=localStorage.getItem("mtg_source")||"tmdb",this.searchQuery="",this.search_type="trending",this.edit_post_link="",this.search_btn=document.getElementById("search_movie_btn"),this.search_input=document.querySelector(".search_input_field"),this.currentTab_btn=document.getElementById(this.currentTab),this.currentTabSource_btn=document.getElementById(this.currentTabSource),this.pluginUrl=movieTvVars.plugin_url,this.TMDB_KEY=movieTvVars.apiKeys.mtg_tmdb_api_key,this.FP_KEY=movieTvVars.apiKeys.mtg_fp_api_key,null!==this.search_btn&&null!==this.search_input){if(!this.TMDB_KEY||!this.FP_KEY)return this.manageSearchFields(this.search_btn,!0),this.add_search_report("INIT","Please set the TMDB and FP APIKeys in the plugin settings.","darkred"),errorText.textContent="Please set the TMDB and FP APIKeys in the plugin settings.",errorText.style.color="darkred",void(errorText.style.textAlign="center");this.add_search_report("INIT","Movie TV Generator Initialized.","gray"),this.initButtons("tab-button",this.currentTab),this.initButtons("source-button",this.currentTabSource),this.loadTrendingContent()}else"function"==typeof fpLog&&fpLog("JS","Search button or input field not found.")}initButtons(buttonClass,activeId){const buttons=document.getElementsByClassName(buttonClass);for(let i=0;i<buttons.length;i++)buttons[i].classList.toggle("active",buttons[i].id===activeId)}selectTab(evt,tabName){this.updateActiveButton("tab-button",tabName),this.currentTab=tabName,localStorage.setItem("mtg_tab",this.currentTab),this.cleanUpResults(),this.loadTrendingContent()}selectSource(evt,source){this.updateActiveButton("source-button",source),this.currentTabSource=source,localStorage.setItem("mtg_source",this.currentTabSource),this.cleanUpResults(),this.loadTrendingContent()}updateActiveButton(buttonClass,activeId){const buttons=document.getElementsByClassName(buttonClass);for(let i=0;i<buttons.length;i++)buttons[i].classList.toggle("active",buttons[i].id===activeId)}loadTrendingContent(){this.cleanUpResults();var defaultText="tmdb"===this.currentTabSource?"Trending":"Latest FP";this.add_search_report("DEFAULT",`Loading ${defaultText} -> ${this.currentTab.charAt(0).toUpperCase()+this.currentTab.slice(1)}`,"purple"),document.getElementById("search_loading").style.display="flex",this.manageSearchFields(this.search_btn,!0),this.manageSearchFields(this.currentTab_btn,!0),this.manageSearchFields(this.currentTabSource_btn,!0),this.makeAPIRequest(this.currentTab,"trending","none","1",this.currentTabSource)}add_search_report(reportType,reportText,color="black",isPostCreated=!1,isPostExists=!1,editPostURL="",post_id="und",tmdb_id="und",post_type="und",preview_url=""){const search_report=document.getElementById("result-report"),result_report_inner=document.createElement("div");result_report_inner.className="result-report-grid",result_report_inner.style.opacity=0;const report=document.createElement("div");report.className="report_type",report.innerHTML=`<p class="report_type_text">${reportType}</p>`,report.style.fontWeight="bold",report.style.color=color;const report_text=document.createElement("div");report_text.className="report_text",report_text.innerHTML=isPostCreated||isPostExists?`<p class="report_text_text">Post created -> <a href="${editPostURL}" target="_blank">edit</a>  |  <a href="${preview_url}" target="_blank">view</a>  |  <a href="https://www.themoviedb.org/${post_type}/${tmdb_id}" target="_blank">TMDB: ${tmdb_id}</a></p>`:`<p class="report_text_text">${reportText}</p>`,result_report_inner.appendChild(report),result_report_inner.appendChild(report_text),search_report.appendChild(result_report_inner),result_report_inner.offsetWidth,result_report_inner.style.opacity=1,setTimeout((()=>{result_report_inner.style.opacity=1,search_report.scrollTop=search_report.scrollHeight}),100)}async makeAPIRequest(type,s_type,query,page_number=1,source){if(type&&s_type&&["movie","tv"].includes(type)&&["search","id","trending"].includes(s_type))if("search"!==s_type&&"id"!==s_type||query)try{const response=await this.fetch_tmdb_data(type,s_type,query,page_number,source);if(!response)throw this.add_search_report("SEARCH",`${response.message}`,"red"),new Error(response.message);const data=await response;if(!data)throw this.add_search_report("SEARCH",response.message,"red"),new Error(response.message);const results=data.results;if("search"===s_type&&results&&results.length>0)this.displayResults_keyword(results,data.pages,data.page,data.mtime,data.total);else if("id"===s_type&&results)this.displayResults_keyword([results],1,1,data.mtime,1);else if("trending"===s_type&&"tmdb"===source&&results)this.displayResults_keyword(results,1,1,data.mtime,1);else if("trending"===s_type&&"fp"===source&&results&&results.length<1)this.add_search_report("SEARCH","No Files Found in FilePress.","red"),this.setBackTypeInCaseOfError();else{if(!("trending"===s_type&&"fp"===source&&results&&results.length>0))throw this.setBackTypeInCaseOfError(),new Error(response.message);this.displayResults_keyword(results,data.pages,data.page,data.mtime,data.total)}}catch(error){this.add_search_report("SEARCH",`${error}`,"red"),this.setBackTypeInCaseOfError()}else"function"==typeof fpLog&&fpLog("JS","Empty query for search or id search type.");else"function"==typeof fpLog&&fpLog("JS","Invalid or incomplete parameters for API request.")}displayResults_keyword(results,totalPages,currentPage,time,total_items){const container=document.getElementById("results-inner-container");if(!container)return void("function"==typeof fpLog&&fpLog("JS","The container #results-inner-container does not exist."));container.style.display="flex",1===currentPage&&(container.innerHTML="");let total_children=0;const tmdb_ids=results.map((result=>result.id));this.checkTMDB_ID(tmdb_ids).then((existenceMap=>{results.forEach((result=>{const exists=existenceMap[result.id].exists,tmdb_card_div=this.createResultCard(result,exists);container.appendChild(tmdb_card_div)})),this.updateLoadMoreButton(currentPage,totalPages),this.setBackTypeInCaseOfError(),total_children=container.querySelectorAll(".tmdb_card").length,this.display_tmdb_status(total_items,total_children,currentPage,time)})).catch((error=>{this.add_search_report("SEARCH",`${error.message}`,"red"),this.setBackTypeInCaseOfError(),"function"==typeof fpLog&&fpLog("JS",error)}))}setBackTypeInCaseOfError(){document.getElementById("search_loading").style.display="none",this.manageSearchFields(this.search_btn),this.manageSearchFields(this.currentTab_btn),this.manageSearchFields(this.currentTabSource_btn)}display_tmdb_status(total_items,total_children,currentPage,time){const tmdb_status_container=document.getElementById("results-inner-container_status");document.getElementById("results-inner-container_status_text").textContent=`About ${total_items} results found, loaded ${total_children} items & current page is ${currentPage}. (${time} seconds)`,tmdb_status_container.style.display="block",tmdb_status_container.style.paddingLeft="10px"}updateLoadMoreButton(currentPage,totalPages){const loadMoreContainer=document.getElementById("load-more"),existingButton=document.getElementById("load-more-button");existingButton&&(loadMoreContainer.removeChild(existingButton),document.getElementById("load_more_results_btn_div_container")?.remove());const loading_div_container=document.createElement("div");loading_div_container.id="load_more_results_btn_div_container",loading_div_container.style.cssText="display: none; justify-content: center; align-items: center; height: 100%; max-w";const loading=document.createElement("div");if(loading.id="load-more-loading",loading.style.cssText="position: relative; width: 30px; height: 30px;",loading.innerHTML=`<img class="animate-spin" src="${this.pluginUrl}/img/loading.webp" alt="loading" style="width: 100%; height: 100%;">`,loading_div_container.appendChild(loading),currentPage<totalPages){loadMoreContainer.style.cssText="display: flex; justify-content: center; align-items: center; flex-direction: column;";const loadMoreBtn=document.createElement("button");loadMoreBtn.id="load-more-button",loadMoreBtn.classList.add("load_more_btn"),loadMoreBtn.textContent="Load More",loadMoreBtn.onclick=()=>{loading_div_container.style.display="flex",loadMoreContainer.appendChild(loading_div_container),this.makeAPIRequest(this.currentTab,this.search_type,this.searchQuery,currentPage+1,this.currentTabSource),loadMoreBtn.style.display="none"},loadMoreContainer.appendChild(loadMoreBtn)}}createTickForExisting(){const existingIndicator=document.createElement("div");return existingIndicator.className="existing-tmdb-id",existingIndicator.style.cssText="position: absolute; top: 0; right: 0; z-index: 1; cursor: not-allowed;",existingIndicator.innerHTML=`<img src="${this.pluginUrl}/img/green-tick.webp" alt="Exists" style="width: 24px; height: 24px;">`,existingIndicator}createLoadingAnimation(){const loading=document.createElement("div");return loading.id="add-post-loading",loading.style.cssText="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); -webkit-transform: translate(-50%, -50%); -moz-transform: translate(-50%, -50%); -ms-transform: translate(-50%, -50%); -o-transform: translate(-50%, -50%);",loading.innerHTML=`<img class="animate-spin" src="${this.pluginUrl}/img/loading.webp" alt="adding-post" style="width: 100%; height: 100%;">`,loading}getPosterFullPath(poster_path){let poster_url;return poster_url=poster_path?`https://image.tmdb.org/t/p/w154${poster_path}`:"https://imgshare.xyz/img/4/666a6128c0fff3ca1bfc7715/ImageNotFound.png",poster_url}createValidPostData(result){if(!result)return null;return{p_type:this.currentTab,tmdb_id:result.id}}createResultCard(result,exists){const tmdb_card_div=document.createElement("div");let releaseDate=result.release_date??result.first_air_date??"",title=result.title??result.name??"Untitled",poster_url=this.getPosterFullPath(result.poster_path??"");tmdb_card_div.classList.add("tmdb_result_item","tmdb_card");const search_img_wrapper=document.createElement("div");search_img_wrapper.className="search_img_wrapper",search_img_wrapper.style.position="relative",search_img_wrapper.style.overflow="hidden";const img=document.createElement("img");img.src=poster_url,img.alt=title,img.className="tmdb-poster";const cardInfoDiv=document.createElement("div");if(cardInfoDiv.className="card-info",cardInfoDiv.innerHTML=`\n      <p class='card-p-base card-title'>${title}</p><br />\n      <p class='card-p-base card-year'>${releaseDate}</p>\n  `,exists){let existingIndicator=this.createTickForExisting();search_img_wrapper.appendChild(existingIndicator),img.style.opacity=.5,img.style.filter="grayscale(100%)",img.style.cursor="not-allowed"}else{img.style.cursor="pointer";let create_data=this.createValidPostData(result);img.onclick=()=>{this.createPostFromTMDB_Data(create_data,search_img_wrapper,img)}}return search_img_wrapper.appendChild(img),tmdb_card_div.appendChild(search_img_wrapper),tmdb_card_div.appendChild(cardInfoDiv),tmdb_card_div}fetch_tmdb_data(type,s_type,query,page_number,source){return new Promise(((resolve,reject)=>{jQuery.ajax({url:movieTvVars.ajax_url,type:"POST",data:{action:"fp_app_search",type:type,s_type:s_type,query:query,page_number:page_number,source:source,nonce:movieTvVars.nonce},success:response=>{resolve(response)},error:function(jqXHR,textStatus,errorThrown){"function"==typeof fpLog&&fpLog("JS","Request failed [Fetch_TMDB_Data]: "+textStatus+", "+errorThrown),reject(!1)}})}))}checkTMDB_ID(tmdb_ids){let post_type="movie"===this.currentTab?"movie":"series";return new Promise(((resolve,reject)=>{jQuery.ajax({url:movieTvVars.ajax_url,type:"POST",data:{action:"check_tmdb_id_exists",tmdb_ids:JSON.stringify(tmdb_ids),mtg_post_type:post_type,nonce:movieTvVars.nonce},success:response=>{response.success&&response.data.existence_map?resolve(response.data.existence_map):reject("No data received or error in response")},error:function(jqXHR,textStatus,errorThrown){"function"==typeof fpLog&&fpLog("JS","Request failed [Check_TMDB_Exist_FUNCTION]: "+textStatus+", "+errorThrown);try{const responseJSON=JSON.parse(jqXHR.responseText);reject(responseJSON.data.message)}catch(error){reject("Error validating postData.")}reject("Error: "+textStatus)}})}))}checkTMDB_ID_FP(tmdb_id,type){try{jQuery.ajax({url:movieTvVars.ajax_url,type:"POST",data:{action:"check_if_tmdb_id_exists_fp",tmdb_id:tmdb_id,type:type,nonce:movieTvVars.nonce},success:response=>response.exists,error:function(jqXHR,textStatus,errorThrown){return"function"==typeof fpLog&&fpLog("JS","Request failed [Check_TMDB_Exist_FP]: "+textStatus+", "+errorThrown),!1}})}catch(error){return"function"==typeof fpLog&&fpLog("JS","Error: "+error),!1}}createPostFromTMDB_Data(tmdbData,search_img_wrapper,img){let loading=this.createLoadingAnimation();const self=this;search_img_wrapper.appendChild(loading);try{img.style.opacity=.5,img.style.filter="grayscale(100%)",jQuery.ajax({url:movieTvVars.ajax_url,type:"POST",data:{action:"create_movie_post",nonce:movieTvVars.nonce,tmdbData:tmdbData},success:response=>{let post_id=response?.data.post_id??"null",post_edit_url=response?.data.post_edit_url??"",tmdb_id=response?.data.tmdb_id??"",post_type=response?.data.post_type??"",preview_url=response?.data.preview_url??"";this.add_search_report("POST","","green",!0,!1,post_edit_url,post_id,tmdb_id,post_type,preview_url),img.style.cursor="not-allowed",img.onclick=null;let existingIndicator=this.createTickForExisting();return search_img_wrapper.removeChild(loading),search_img_wrapper.appendChild(existingIndicator),response.data.post_id},error:function(jqXHR,textStatus,errorThrown){search_img_wrapper.removeChild(loading),img.style.opacity=1,img.style.filter="none","function"==typeof fpLog&&fpLog("JS","Request failed [Create_Post]: "+textStatus+", "+errorThrown);try{var responseJSON=JSON.parse(jqXHR.responseText);self.add_search_report("POST",`${responseJSON.data.message}`,"red")}catch(error){self.add_search_report("POST",`${errorThrown}`,"red")}return!1}})}catch(error){return search_img_wrapper.removeChild(loading),img.style.opacity=1,img.style.filter="none","function"==typeof fpLog&&fpLog("JS","Error: "+error),!1}}async searchInitiator(){if(this.searchQuery=document.getElementById("mtg_query").value.trim(),!this.searchQuery)return this.add_search_report("SEARCH","Please enter a search query.","red");this.previousQuery=this.searchQuery,this.cleanUpResults();let isNumeric=!isNaN(this.searchQuery)&&!isNaN(parseFloat(this.searchQuery));this.search_type=isNumeric?"id":"search",document.getElementById("search_loading").style.display="flex",this.manageSearchFields(this.search_btn,!0),this.add_search_report("SEARCH",`Searching for: ${this.searchQuery}`,"green"),await this.makeAPIRequest(this.currentTab,this.search_type,this.searchQuery)}manageSearchFields(btn,status=!1){btn.disabled=status,btn.style.cursor=btn.disabled?"not-allowed":"pointer",this.search_input.style.cursor=btn.disabled?"not-allowed":"text",this.search_input.readOnly=btn.disabled}cleanUpResults(){document.getElementById("results-inner-container").innerHTML="",document.getElementById("load-more").style.display="none",document.getElementById("results-inner-container_status").style.display="none",this.manageSearchFields(this.search_btn),this.manageSearchFields(this.currentTab_btn),this.manageSearchFields(this.currentTabSource_btn)}}document.addEventListener("DOMContentLoaded",(event=>{const postGen=new PostGenerator;window.postGen=postGen,document.querySelector(".tab-selector").addEventListener("click",(event=>{event.target.classList.contains("tab-button")&&postGen.selectTab(event,event.target.id)})),document.querySelector(".source-selector").addEventListener("click",(event=>{event.target.classList.contains("source-button")&&postGen.selectSource(event,event.target.id)}))}));